---
- name: Send POPUP_MESSAGE to logged in users
  hosts: windows
  gather_facts: no
  tasks:
    - name: Confirm environment variable
      debug:
        msg: "{{ lookup('env', 'POPUP_MESSAGE') }}"

    - name: Send POPUP_MESSAGE to logged in users
      community.windows.win_toast:
        expire: 60
        title: System Upgrade Notification
        msg: "{{ lookup('env', 'POPUP_MESSAGE') }}"
      async: 60
      poll: 0

    - name: Send message using msg.exe
      ansible.windows.win_shell: |
        $session = (query user | Where-Object { $_ -match "Active" }) -split '\s+'
        $username = $session[0]
        msg $username "{{ lookup('env', 'POPUP_MESSAGE') }}"
